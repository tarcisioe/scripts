#!/bin/bash

source scriptlib-init

require util

SSHOT_DIR="${HOME}/.screenshots"


usage() {
echo "\
Usage: $(script-name) [OPTION...]
Take a screenshot and either save it or copy it to clipboard.

Optional arguments:
    -c/--clipboard   Copy screenshot to clipboard.
    -h/--help        Print this help message and exit.
    -s/--select      Enable region selection."
}


get-save-path() {
    # Use dmenu to get the filename to save.
    #
    # Usage: get-save-path DIRECTORY
    #
    # Positional arguments:
    #     DIRECTORY   Where to save the file.

    local directory="${1}"

    local filename
    filename="$(dmenu -p "Filename (.png)" < /dev/null)" &&

    echo "${directory}/${filename}.png"
}


save() {
    # Save a file to directory chosen by the user.
    #
    # Usage: save FILE DIRECTORY
    #
    # Positional arguments:
    #     FILE        The file to save.
    #     DIRECTORY   Where to save it.

    local file="${1}"
    local directory="${2}"

    mkdir -p "${directory}" &&

    local path
    path="$(get-save-path "${directory}")" &&

    cp "${file}" "${path}"
}


copy-to-clipboard() {
    # Copy an image to both selection and clipboard X clipboards.
    #
    # Usage: save-or-clip FILE
    #
    # Positional arguments:
    #     FILE   The file to copy.

    local file="${1}"

    xclip -t image/png "${file}" -selection clipboard &&
    xclip -t image/png "${file}"
}


save-or-clip() {
    # Save or send to clipboard a given temporary file.
    #
    # Usage: save-or-clip CLIP TMPFILE DIRECTORY
    #
    # Positional arguments:
    #     CLIP        A 0/1 flag to send to clipboard or not (save to file).
    #     TMPFILE     The filename of the temporary file. Will be deleted in the
    #                 end.
    #     DIRECTORY   The directory where to save the file if that is the case.

    local clip="${1}"
    local tmpfile="${2}"
    local directory="${3}"

    if [[ "${clip}" == 1 ]]
    then
        copy-to-clipboard "${tmpfile}"
    else
        save "${tmpfile}" "${directory}"
    fi || true  # We actually want to run the rm anyway.

    rm "${tmpfile}"
}


sshot() {
    # Takes a screenshot of the whole screen or a region, and saves it or sends
    # it to the clipboard .
    #
    # Usage: sshot SELECT CLIPBOARD
    #
    # Positional arguments:
    #     SELECT      A 0/1 flag to either select a region or capture the whole
    #                 screen.
    #     CLIPBOARD   A 0/1 flag to send to clipboard or not (save to file).

    local select="${1}"
    local clipboard="${2}"

    local select_flag="$(choose "${select}" "-sB" "")"

    local tmp
    tmp="$(mktemp --suffix=.png)" &&

    maim -ou ${select_flag} "${tmp}" &&
    save-or-clip "${clipboard}" "${tmp}" "${SSHOT_DIR}"
}


main() (
    set -e

    local select=0;
    local clipboard=0;

    local options
    options=$(getopt -o hsc -l help,select,clipboard -- "$@")
    eval set -- "$options"

    while true; do
        case "$1" in
            -h|--help)
                usage && exit 0
                ;;
            -s|--select)
                select=1
                ;;
            -c|--clipboard)
                clipboard=1
                ;;
            --) shift ;&
            *) break ;;
        esac
        shift
    done

    sshot "${select}" "${clipboard}"
)


main "$@"
